<!-- Kopieren Sie den gesamten Code von hier an in Ihr Moodle-Textfeld (Situation 2 vorkonfiguriert) -->

<!-- 1. HTML-Struktur: Container für den Inhalt und Lade-Hinweis -->
<div id="content_container">
    <div style="text-align: center; padding: 2rem;">
        <p>Lade Inhalte...</p>
        <!-- Optional: Ein einfacher CSS-Spinner -->
        <div style="margin: auto; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 2s linear infinite;"></div>
    </div>
</div>
<style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<!-- 2. JavaScript-Logik zum Laden und Verarbeiten der Inhalte -->
<script type="module">
    // ============== KONFIGURATION ==============
    const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
    // Bevorzugter Pfad: neue Ordnerstruktur
    const baseUrl = isLocal 
        ? 'courses/situation_2/chapters/' 
        : 'https://cdn.jsdelivr.net/gh/andrkelb-school/SW_course@latest/courses/situation_2/chapters/';
    // Fallback: Altpfad
    const fallbackBaseUrl = isLocal 
        ? 'github_content/' 
        : 'https://cdn.jsdelivr.net/gh/andrkelb-school/SW_course@latest/github_content/';

    // Immer Situation 2
    const chapters = [
        { id: '2.0', title: 'SmartHome Systems', file: 'seite2.0_smarthome_systems.html' },
        { id: '2.1', title: 'Der Logik-Architekt', file: 'seite2.1_logik_architekt.html' }
    ];

    // Optional: Dateiname via URL-Parameter ?datei=seite2.1_logik_architekt.html
    const urlParams = new URLSearchParams(window.location.search);
    let currentFile = urlParams.get('datei') || chapters[0].file;

    const markerRegex = /<!--\s*HIER_STARTET_DER_INHALT\s*-->/g;
    const contentContainer = document.getElementById('content_container');

    function fixRelativePaths(htmlString, base) {
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlString;
        const elementsToFix = tempDiv.querySelectorAll('[src], [href]');
        elementsToFix.forEach(el => {
            if (el.hasAttribute('src')) {
                const path = el.getAttribute('src');
                if (path && !path.startsWith('http') && !path.startsWith('#') && !path.startsWith('mailto:')) {
                    el.setAttribute('src', base + path);
                }
            }
            if (el.hasAttribute('href')) {
                const path = el.getAttribute('href');
                if (path && !path.startsWith('http') && !path.startsWith('#') && !path.startsWith('mailto:')) {
                    el.setAttribute('href', base + path);
                }
            }
        });
        return tempDiv.innerHTML;
    }

    function renderTOC(activeFile) {
        if (document.getElementById('moodle_toc')) return;
        const toc = document.createElement('nav');
        toc.id = 'moodle_toc';
        toc.style.maxWidth = '900px';
        toc.style.margin = '0 auto 1rem auto';
        toc.style.padding = '0.75rem 1rem';
        toc.style.border = '1px solid #d6d6d6';
        toc.style.borderRadius = '6px';
        toc.style.background = '#ffffff';
        toc.style.fontFamily = 'Arial, sans-serif';
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.alignItems = 'center';
        header.style.justifyContent = 'space-between';
        header.style.cursor = 'pointer';
        header.setAttribute('aria-expanded', 'true');
        const h = document.createElement('h4');
        h.textContent = 'Kapitel – Situation 2';
        h.style.margin = '0';
        h.style.fontSize = '1rem';
        h.style.color = '#005691';
        const toggle = document.createElement('span');
        toggle.id = 'moodle_toc_toggle';
        toggle.textContent = '▼';
        toggle.style.fontSize = '0.85rem';
        toggle.style.color = '#005691';
        toggle.style.userSelect = 'none';
        header.appendChild(h);
        header.appendChild(toggle);
        toc.appendChild(header);
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.padding = '0';
        ul.style.margin = '0';
        ul.id = 'moodle_toc_list';
        chapters.forEach(ch => {
            const li = document.createElement('li');
            li.style.margin = '0';
            const a = document.createElement('a');
            a.textContent = ch.id + ' ' + ch.title;
            a.href = 'javascript:void(0)';
            a.style.display = 'block';
            a.style.padding = '0.4rem 0.55rem';
            a.style.fontSize = '0.85rem';
            a.style.textDecoration = 'none';
            a.style.color = ch.file === activeFile ? '#ffffff' : '#0d3a58';
            a.style.background = ch.file === activeFile ? '#005691' : 'transparent';
            a.style.borderRadius = '4px';
            a.style.transition = 'background .15s ease, padding-left .15s ease';
            a.addEventListener('mouseover', () => { if (ch.file !== activeFile) a.style.background = '#eef6fb'; });
            a.addEventListener('mouseout', () => { if (ch.file !== activeFile) a.style.background = 'transparent'; });
            a.addEventListener('click', () => {
                currentFile = ch.file;
                loadContent(ch.file);
                document.getElementById('moodle_toc').remove();
                renderTOC(ch.file);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            li.appendChild(a);
            ul.appendChild(li);
        });
        toc.appendChild(ul);
        contentContainer.parentNode.insertBefore(toc, contentContainer);
        let collapsed = JSON.parse(localStorage.getItem('moodle_toc_collapsed') || 'false');
        function applyCollapseState() {
            if (collapsed) {
                ul.style.display = 'none';
                toggle.textContent = '▲';
                header.setAttribute('aria-expanded', 'false');
            } else {
                ul.style.display = 'block';
                toggle.textContent = '▼';
                header.setAttribute('aria-expanded', 'true');
            }
        }
        header.addEventListener('click', () => {
            collapsed = !collapsed;
            localStorage.setItem('moodle_toc_collapsed', JSON.stringify(collapsed));
            applyCollapseState();
        });
        applyCollapseState();
    }

    async function loadContent(fileToLoad = currentFile) {
        try {
            let fetchUrl = `${baseUrl}${fileToLoad}?t=${Date.now()}`;
            let response = await fetch(fetchUrl);
            if (!response.ok) {
                console.warn(`Primärpfad fehlgeschlagen (${response.status}) – versuche Fallback`);
                fetchUrl = `${fallbackBaseUrl}${fileToLoad}?t=${Date.now()}`;
                response = await fetch(fetchUrl);
            }
            if (!response.ok) {
                throw new Error(`Datei nicht gefunden oder Server-Fehler (Status: ${response.status})`);
            }
            const fullHtml = await response.text();
            let matches = [...fullHtml.matchAll(markerRegex)];
            let extractedContent = '';
            if (matches.length >= 2) {
                const first = matches[0];
                const second = matches[1];
                const startIndex = first.index + first[0].length;
                const endIndex = second.index;
                extractedContent = fullHtml.slice(startIndex, endIndex);
            } else {
                const encodedRegex = /&lt;!--\s*HIER_STARTET_DER_INHALT\s*--&gt;/g;
                const encMatches = [...fullHtml.matchAll(encodedRegex)];
                if (encMatches.length >= 2) {
                    const first = encMatches[0];
                    const second = encMatches[1];
                    const startIndex = first.index + first[0].length;
                    const endIndex = second.index;
                    extractedContent = fullHtml.slice(startIndex, endIndex);
                    matches = encMatches;
                } else {
                    const bodyMatch = /<body[^>]*>([\s\S]*?)<\/body>/i.exec(fullHtml);
                    if (bodyMatch) {
                        extractedContent = bodyMatch[1];
                        console.warn('Marker nicht gefunden – Fallback auf gesamten Body-Inhalt angewendet.');
                    } else {
                        throw new Error(`Der Marker wurde nicht gefunden und kein <body>-Block extrahierbar. (Matches: ${matches.length})`);
                    }
                }
            }
            extractedContent = fixRelativePaths(extractedContent, baseUrl);
            contentContainer.innerHTML = extractedContent;
            function attachLinkHandlers() {
                const anchors = contentContainer.querySelectorAll('a[href]');
                anchors.forEach(a => {
                    const href = a.getAttribute('href');
                    if (!href) return;
                    if (href.startsWith('#') || href.startsWith('mailto:') || (href.startsWith('http') && !href.startsWith(baseUrl))) {
                        return;
                    }
                    a.addEventListener('click', async (ev) => {
                        ev.preventDefault();
                        try {
                            let fetchUrl = `${a.href}?t=${Date.now()}`;
                            let res = await fetch(fetchUrl);
                            if (!res.ok) {
                                try {
                                    const url = new URL(a.href);
                                    const replaced = url.href.replace(baseUrl, fallbackBaseUrl);
                                    fetchUrl = `${replaced}?t=${Date.now()}`;
                                    res = await fetch(fetchUrl);
                                } catch {}
                            }
                            if (!res.ok) throw new Error(`Fehler beim Laden (Status: ${res.status})`);
                            const html = await res.text();
                            const subMatches = [...html.matchAll(markerRegex)];
                            let newContent;
                            if (subMatches.length >= 2) {
                                const sFirst = subMatches[0];
                                const sSecond = subMatches[1];
                                const sStart = sFirst.index + sFirst[0].length;
                                const sEnd = sSecond.index;
                                newContent = html.slice(sStart, sEnd);
                            } else {
                                newContent = html;
                            }
                            const fixed = fixRelativePaths(newContent, baseUrl);
                            contentContainer.innerHTML = fixed;
                            attachLinkHandlers();
                        } catch (err) {
                            console.error('Fehler beim Laden verlinkter Seite:', err);
                            contentContainer.innerHTML = `<div style="border: 2px solid red; background-color: #ffebee; padding: 1rem; color: #c62828;"><strong>Fehler beim Laden der verlinkten Seite</strong><p>${err.message}</p></div>`;
                        }
                    });
                });
            }
            attachLinkHandlers();
            renderTOC(fileToLoad);
        } catch (error) {
            console.error('Fehler beim Laden des Inhalts:', error);
            contentContainer.innerHTML = `
                <div style="border: 2px solid red; background-color: #ffebee; padding: 1rem; color: #c62828;">
                    <strong>Fehler beim Laden der Inhalte</strong>
                    <p>${error.message}</p>
                    <p>Bitte überprüfen Sie die Konfiguration im Skript oder die Verfügbarkeit der Zieldatei.</p>
                </div>
            `;
        }
    }

    loadContent(currentFile);
</script>

<!-- Ende des kopierbaren Codes -->
